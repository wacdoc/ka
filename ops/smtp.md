# შექმენით თქვენი საკუთარი SMTP ფოსტის გაგზავნის სერვერი

## პრეამბულა

SMTP-ს შეუძლია პირდაპირ შეიძინოს სერვისები ღრუბლოვანი გამყიდველებისგან, როგორიცაა:

* [Amazon SES SMTP](https://docs.aws.amazon.com/ses/latest/dg/send-email-smtp.html)
* [ალის ღრუბელი ელფოსტის დაჭერა](https://www.alibabacloud.com/help/directmail/latest/three-mail-sending-methods)

თქვენ ასევე შეგიძლიათ შექმნათ თქვენი საკუთარი ფოსტის სერვერი - შეუზღუდავი გაგზავნა, დაბალი საერთო ღირებულება.

ქვემოთ, ჩვენ ეტაპობრივად ვაჩვენებთ, თუ როგორ უნდა ავაშენოთ ჩვენი საკუთარი ფოსტის სერვერი.

## სერვერის შერჩევა

თვითმმართველობის SMTP სერვერს სჭირდება საჯარო IP პორტები 25, 456 და 587 ღია.

ჩვეულებრივად გამოყენებულმა საჯარო ღრუბლებმა დაბლოკა ეს პორტები ნაგულისხმევად და შესაძლოა მათი გახსნა სამუშაო შეკვეთის გაცემით იყოს შესაძლებელი, მაგრამ ეს ძალიან პრობლემურია.

მე გირჩევთ შეიძინოთ ჰოსტიდან, რომელსაც აქვს ეს პორტები ღია და მხარს უჭერს საპირისპირო დომენური სახელების დაყენებას.

აი, მე გირჩევთ [Contabo-ს](https://contabo.com) .

Contabo არის ჰოსტინგის პროვაიდერი, რომელიც დაფუძნებულია მიუნხენში, გერმანიაში, დაარსდა 2003 წელს ძალიან კონკურენტუნარიანი ფასებით.

თუ შეძენის ვალუტად ევროს აირჩევთ, ფასი უფრო იაფი იქნება (სერვერი 8 GB მეხსიერებით და 4 CPU ღირს წელიწადში დაახლოებით 529 იუანი, ხოლო საწყისი ინსტალაციის საფასური ერთი წლის განმავლობაში უფასოა).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/UoAQkwY.webp)

შეკვეთის გაფორმებისას შენიშვნა `prefer AMD` და AMD CPU სერვერს უკეთესი შესრულება ექნება.

შემდეგში ავიღებ Contabo-ს VPS-ს, როგორც მაგალითს იმის დემონსტრირებისთვის, თუ როგორ უნდა შექმნათ თქვენი საკუთარი ფოსტის სერვერი.

## Ubuntu სისტემის კონფიგურაცია

ოპერაციული სისტემა აქ არის Ubuntu 22.04

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/smpIu1F.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/m7Mwjwr.webp)

თუ სერვერი ssh-ზე აჩვენებს `Welcome to TinyCore 13!` (როგორც ნაჩვენებია ქვემოთ მოცემულ სურათზე), ეს ნიშნავს, რომ სისტემა ჯერ არ არის დაინსტალირებული. გთხოვთ, გათიშეთ ssh და დაელოდეთ რამდენიმე წუთს ხელახლა შესვლისთვის.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/-qKACz9.webp)

როდესაც `Welcome to Ubuntu 22.04.1 LTS` გამოჩნდება, ინიციალიზაცია დასრულებულია და შეგიძლიათ გააგრძელოთ შემდეგი ნაბიჯები.

### [სურვილისამებრ] განვითარების გარემოს ინიციალიზაცია

ეს ნაბიჯი არჩევითია.

მოხერხებულობისთვის, მე დავაყენე ubuntu პროგრამული უზრუნველყოფის ინსტალაცია და სისტემის კონფიგურაცია [github.com/wactax/ops.os/tree/main/ubuntu-](https://github.com/wactax/ops.os/tree/main/ubuntu) ში.

დააინსტალირეთ შემდეგი ბრძანება ერთი დაწკაპუნებით.

```
bash <(curl -s https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

ჩინელი მომხმარებლები, გთხოვთ გამოიყენოთ შემდეგი ბრძანება ამის ნაცვლად და ენა, დროის სარტყელი და ა.შ. ავტომატურად დაყენდება.

```
CN=1 bash <(curl -s https://ghproxy.com/https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

### Contabo ჩართავს IPV6-ს

ჩართეთ IPV6, რათა SMTP-მ ასევე შეძლოს ელფოსტის გაგზავნა IPV6 მისამართებით.

რედაქტირება `/etc/sysctl.conf`

შეცვალეთ ან დაამატეთ შემდეგი ხაზები

```
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
```

დაიცავით [კონტაბო გაკვეთილი: თქვენს სერვერზე IPv6 კავშირის დამატება](https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/)

შეცვალეთ `/etc/netplan/01-netcfg.yaml` , დაამატეთ რამდენიმე სტრიქონი, როგორც ეს ნაჩვენებია ქვემოთ მოცემულ ფიგურაში (Contabo VPS ნაგულისხმევი კონფიგურაციის ფაილს უკვე აქვს ეს ხაზები, უბრალოდ გააუქმეთ ისინი).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/5MEi41I.webp)

შემდეგ `netplan apply` , რათა შეცვლილი კონფიგურაცია ძალაში შევიდეს.

კონფიგურაციის წარმატებით დასრულების შემდეგ, შეგიძლიათ გამოიყენოთ `curl 6.ipw.cn` თქვენი გარე ქსელის ipv6 მისამართის სანახავად.

## კონფიგურაციის საცავის ოპერაციების კლონირება

```
git clone https://github.com/wactax/ops.soft.git
```

## შექმენით უფასო SSL სერთიფიკატი თქვენი დომენის სახელისთვის

ფოსტის გაგზავნისთვის საჭიროა SSL სერთიფიკატი დაშიფვრისა და ხელმოწერისთვის.

ჩვენ ვიყენებთ [acme.sh](https://github.com/acmesh-official/acme.sh) სერთიფიკატების გენერირებისთვის.

acme.sh არის ღია კოდის ავტომატური სერტიფიკატის ხელმოწერის ინსტრუმენტი,

შეიყვანეთ კონფიგურაციის საწყობში ops.soft, გაუშვით `./ssl.sh` და **ზედა დირექტორიაში** შეიქმნება `conf` საქაღალდე.

იპოვეთ თქვენი DNS პროვაიდერი [acme.sh dnsapi-](https://github.com/acmesh-official/acme.sh/wiki/dnsapi) დან, შეცვალეთ `conf/conf.sh` .

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Qjq1C1i.webp)

შემდეგ გაუშვით `./ssl.sh 123.com` თქვენი დომენის სახელისთვის `123.com` და `*.123.com` სერთიფიკატების შესაქმნელად.

პირველი გაშვება ავტომატურად დააინსტალირებს [acme.sh-ს](https://github.com/acmesh-official/acme.sh) და დაამატებს დაგეგმილ ამოცანას ავტომატური განახლებისთვის. შეგიძლიათ იხილოთ `crontab -l` , არის ასეთი ხაზი შემდეგნაირად.

```
52 0 * * * "/mnt/www/.acme.sh"/acme.sh --cron --home "/mnt/www/.acme.sh" > /dev/null
```

გენერირებული სერთიფიკატის გზა არის მსგავსი `/mnt/www/.acme.sh/123.com_ecc。`

სერთიფიკატის განახლება გამოიძახებს `conf/reload/123.com.sh` სკრიპტს, შეცვალეთ ეს სკრიპტი, შეგიძლიათ დაამატოთ ბრძანებები, როგორიცაა `nginx -s reload` , რომ განაახლოთ დაკავშირებული აპლიკაციების სერტიფიკატის ქეში.

## შექმენით SMTP სერვერი chasquid-ით

[chasquid](https://github.com/albertito/chasquid) არის ღია კოდის SMTP სერვერი დაწერილი Go ენაზე.

როგორც ძველი ფოსტის სერვერის პროგრამების შემცვლელი, როგორიცაა Postfix და Sendmail, chasquid უფრო მარტივი და გამოსაყენებელია, ასევე უფრო ადვილია მეორადი განვითარებისთვის.

გაუშვით `./chasquid/init.sh 123.com` ავტომატურად დაინსტალირდება ერთი დაწკაპუნებით (ჩაანაცვლეთ 123.com თქვენი გამგზავნი დომენის სახელით).

## ელ.ფოსტის ხელმოწერის DKIM კონფიგურაცია

DKIM გამოიყენება ელ.ფოსტის ხელმოწერების გასაგზავნად, რათა თავიდან იქნას აცილებული წერილები სპამად.

ბრძანების წარმატებით გაშვების შემდეგ, თქვენ მოგეთხოვებათ დააყენოთ DKIM ჩანაწერი (როგორც ნაჩვენებია ქვემოთ).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/LJWGsmI.webp)

უბრალოდ დაამატეთ TXT ჩანაწერი თქვენს DNS-ში (როგორც ნაჩვენებია ქვემოთ).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/0szKWqV.webp)

## იხილეთ სერვისის სტატუსი და ჟურნალები

 `systemctl status chasquid` სერვისის სტატუსის ნახვა.

ნორმალური მუშაობის მდგომარეობა, როგორც ნაჩვენებია ქვემოთ მოცემულ ფიგურაში

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/CAwyY4E.webp)

 `grep chasquid /var/log/syslog` ან `journalctl -xeu chasquid` შეუძლია შეცდომების ჟურნალის ნახვა.

## საპირისპირო დომენის კონფიგურაცია

საპირისპირო დომენის სახელი არის იმის საშუალება, რომ IP მისამართი გადაწყდეს შესაბამის დომენის სახელზე.

საპირისპირო დომენის სახელის დაყენება ხელს უშლის ელ.ფოსტის სპამის იდენტიფიცირებას.

ფოსტის მიღებისას, მიმღები სერვერი შეასრულებს საპირისპირო დომენის სახელების ანალიზს გამომგზავნი სერვერის IP მისამართზე, რათა დაადასტუროს, აქვს თუ არა გამგზავნი სერვერს სწორი საპირისპირო დომენის სახელი.

თუ გაგზავნის სერვერს არ აქვს საპირისპირო დომენის სახელი ან თუ საპირისპირო დომენის სახელი არ ემთხვევა გაგზავნის სერვერის IP მისამართს, მიმღებ სერვერს შეუძლია ელფოსტა სპამად აღიაროს ან უარყოს იგი.

ეწვიეთ [https://my.contabo.com/rdns](https://my.contabo.com/rdns) და დააკონფიგურირეთ, როგორც ნაჩვენებია ქვემოთ

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/IIPdBk_.webp)

საპირისპირო დომენის სახელის დაყენების შემდეგ, დაიმახსოვრეთ სერვერზე დომენის სახელის ipv4 და ipv6 გადამისამართების გარჩევადობის კონფიგურაცია.

## დაარედაქტირეთ chasquid.conf-ის ჰოსტის სახელი

შეცვალეთ `conf/chasquid/chasquid.conf` დომენის საპირისპირო სახელის მნიშვნელობით.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/6Fw4SQi.webp)

შემდეგ გაუშვით `systemctl restart chasquid` სერვისის გადატვირთვისთვის.

## კონფის სარეზერვო ასლი git საცავში

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Fier9uv.webp)

მაგალითად, მე ვაკეთებ conf საქაღალდის სარეზერვო ასლს ჩემს საკუთარ github პროცესზე შემდეგნაირად

ჯერ შექმენით კერძო საწყობი

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ZSCT1t1.webp)

შეიყვანეთ conf დირექტორია და გაგზავნეთ საწყობში

```
git init
git add .
git commit -m "init"
git branch -M main
git remote add origin git@github.com:wac-tax-key/conf.git
git push -u origin main
```

## დაამატეთ გამგზავნი

გაშვება

```
chasquid-util user-add i@wac.tax
```

შეუძლია გამგზავნის დამატება

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/khHjLof.webp)

### დარწმუნდით, რომ პაროლი სწორად არის დაყენებული

```
chasquid-util authenticate i@wac.tax --password=xxxxxxx
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/e92JHXq.webp)

მომხმარებლის დამატების შემდეგ განახლდება `chasquid/domains/wac.tax/users` , არ დაგავიწყდეთ საწყობში გაგზავნა.

## DNS დაამატეთ SPF ჩანაწერი

SPF (Sender Policy Framework) არის ელექტრონული ფოსტის გადამოწმების ტექნოლოგია, რომელიც გამოიყენება ელექტრონული ფოსტის თაღლითობის თავიდან ასაცილებლად.

ის ამოწმებს ფოსტის გამგზავნის ვინაობას იმის შემოწმებით, რომ გამგზავნის IP მისამართი ემთხვევა იმ დომენის DNS ჩანაწერებს, რომლებსაც ის აცხადებს, რომ არის, რაც ხელს უშლის თაღლითებს ყალბი ელფოსტის გაგზავნაში.

SPF ჩანაწერების დამატებამ შეიძლება ხელი შეუშალოს ელ.ფოსტის სპამის იდენტიფიცირებას მაქსიმალურად.

თუ თქვენი დომენის სახელის სერვერს არ აქვს SPF ტიპის მხარდაჭერა, უბრალოდ დაამატეთ TXT ტიპის ჩანაწერი.

მაგალითად, `wac.tax` ის SPF ასეთია

`v=spf1 a mx include:_spf.wac.tax include:_spf.google.com ~all`

SPF `_spf.wac.tax` ისთვის

`v=spf1 a:smtp.wac.tax ~all`

გაითვალისწინეთ, რომ აქ `include:_spf.google.com` , ეს იმიტომ, რომ მოგვიანებით დავაკონფიგურირებ `i@wac.tax` , როგორც გაგზავნის მისამართი Google საფოსტო ყუთში.

## DNS კონფიგურაცია DMARC

DMARC არის შემოკლება (დომენზე დაფუძნებული შეტყობინების ავთენტიფიკაცია, მოხსენება და შესაბამისობა).

ის გამოიყენება SPF-ის გადახტომების დასაფიქსირებლად (შეიძლება იყოს გამოწვეული კონფიგურაციის შეცდომით, ან ვინმე ვითომ თქვენ აგზავნის სპამს).

დაამატეთ TXT ჩანაწერი `_dmarc` ,

შინაარსი ასეთია

```
v=DMARC1; p=quarantine; fo=1; ruf=mailto:ruf@wac.tax; rua=mailto:rua@wac.tax
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/k44P7O3.webp)

თითოეული პარამეტრის მნიშვნელობა შემდეგია

### p (პოლიტიკა)

მიუთითებს, თუ როგორ უნდა დამუშავდეს ელფოსტა, რომლებშიც ვერ ხერხდება SPF (გამგზავნის პოლიტიკის ჩარჩო) ან DKIM (დომენის კლავიშების იდენტიფიცირებული ფოსტა) დადასტურება. p პარამეტრი შეიძლება დაყენდეს სამი მნიშვნელობიდან ერთ-ერთზე:

* არცერთი: არანაირი ქმედება არ განხორციელებულა, მხოლოდ დადასტურების შედეგი უბრუნდება გამომგზავნს ელფოსტის მოხსენების მექანიზმის მეშვეობით.
* კარანტინი: ჩადეთ ფოსტა, რომელმაც ვერ გაიარა გადამოწმება სპამის საქაღალდეში, მაგრამ პირდაპირ არ უარს იტყვის ფოსტაზე.
* უარყოფა: პირდაპირ უარყოთ ელ.წერილი, რომლებიც ვერ დადასტურებას ვერ ახერხებენ.

### fo (შეცდომის ვარიანტები)

განსაზღვრავს ანგარიშგების მექანიზმით დაბრუნებული ინფორმაციის რაოდენობას. ის შეიძლება დაყენდეს ერთ-ერთ შემდეგ მნიშვნელობაზე:

* 0: შეატყობინეთ ვალიდაციის შედეგებს ყველა შეტყობინებისთვის
* 1: შეატყობინეთ მხოლოდ შეტყობინებებს, რომლებიც ვერ დადასტურებულია
* დ: შეატყობინეთ მხოლოდ დომენის სახელის დადასტურების წარუმატებლობას
* s: შეატყობინეთ მხოლოდ SPF დადასტურების წარუმატებლობას
* l: შეატყობინეთ მხოლოდ DKIM დადასტურების წარუმატებლობას

### რუა და რუფი

* rua (მოხსენების URI საერთო ანგარიშებისთვის): ელ.ფოსტის მისამართი აგრეგირებული ანგარიშების მისაღებად
* ruf (საანგარიშო URI სასამართლო ანგარიშებისთვის): ელ.ფოსტის მისამართი დეტალური ანგარიშების მისაღებად

## დაამატეთ MX ჩანაწერები ელფოსტის გაგზავნისთვის Google Mail-ში

იმის გამო, რომ მე ვერ ვიპოვე უფასო კორპორატიული საფოსტო ყუთი, რომელიც მხარს უჭერს უნივერსალურ მისამართებს (Catch-All, შეუძლია მიიღოს ნებისმიერი ელ.წერილი, რომელიც გამოგზავნილია ამ დომენის სახელზე, პრეფიქსებზე შეზღუდვის გარეშე), მე გამოვიყენე chasquid ყველა ელფოსტის გაგზავნისთვის ჩემს Gmail საფოსტო ყუთში.

**თუ თქვენ გაქვთ საკუთარი ფასიანი ბიზნეს საფოსტო ყუთი, გთხოვთ, არ შეცვალოთ MX და გამოტოვოთ ეს ნაბიჯი.**

`conf/chasquid/domains/wac.tax/aliases` რედაქტირება, გადამისამართების საფოსტო ყუთის დაყენება

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/OBDl2gw.webp)

`*` მიუთითებს ყველა ელ.წერილს, `i` არის ზემოთ შექმნილი გამომგზავნი მომხმარებლის ელ.ფოსტის მისამართის პრეფიქსი. ფოსტის გადასაგზავნად, თითოეულ მომხმარებელს სჭირდება ხაზის დამატება.

შემდეგ დაამატეთ MX ჩანაწერი (მე პირდაპირ მივუთითებ აქ დომენის საპირისპირო სახელის მისამართს, როგორც ეს ნაჩვენებია პირველ სტრიქონზე ქვემოთ მოცემულ ფიგურაში).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/7__KrU8.webp)

კონფიგურაციის დასრულების შემდეგ, შეგიძლიათ გამოიყენოთ სხვა ელფოსტის მისამართები ელფოსტის გასაგზავნად `i@wac.tax` ზე და `any123@wac.tax` , რათა ნახოთ, შეგიძლიათ თუ არა ელფოსტის მიღება Gmail-ში.

თუ არა, შეამოწმეთ chasquid log ( `grep chasquid /var/log/syslog` ).

## გაგზავნეთ ელფოსტა i@wac.tax-ზე Google Mail-ით

მას შემდეგ, რაც Google Mail-მა მიიღო წერილი, ბუნებრივია, იმედი მქონდა, რომ i.wac.tax@gmail.com-ის ნაცვლად მეპასუხა `i@wac.tax` ით.

ეწვიეთ [https://mail.google.com/mail/u/1/#settings/accounts](https://mail.google.com/mail/u/1/#settings/accounts) და დააწკაპუნეთ "დაამატე სხვა ელფოსტის მისამართი".

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/PAvyE3C.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/_OgLsPT.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/XIUf6Dc.webp)

შემდეგ, შეიყვანეთ დამადასტურებელი კოდი, რომელიც მიღებულია ელფოსტით, რომელსაც გადაეგზავნა.

დაბოლოს, ის შეიძლება დაყენდეს როგორც ნაგულისხმევი გამგზავნის მისამართი (ერთნაირი მისამართით პასუხის ვარიანტთან ერთად).

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/a95dO60.webp)

ამ გზით ჩვენ დავასრულეთ SMTP ფოსტის სერვერის დაარსება და ამავდროულად ვიყენებთ Google Mail-ს ელფოსტის გასაგზავნად და მისაღებად.

## გაგზავნეთ სატესტო ელფოსტა, რათა შეამოწმოთ წარმატებულია თუ არა კონფიგურაცია

შეიყვანეთ `ops/chasquid`

`direnv allow` (direnv დაინსტალირებულია წინა ერთი გასაღების ინიციალიზაციის პროცესში და ჭურვი დაემატა კაუჭს)

შემდეგ გაიქეცი

```
user=i@wac.tax pass=xxxx to=iuser.link@gmail.com ./sendmail.coffee
```

პარამეტრების მნიშვნელობა შემდეგია

* მომხმარებელი: SMTP მომხმარებლის სახელი
* პასი: SMTP პაროლი
* მიმართ: მიმღებს

შეგიძლიათ გამოაგზავნოთ სატესტო ელ.წერილი.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ae1iWyM.webp)

რეკომენდებულია Gmail-ის გამოყენება სატესტო ელფოსტის მისაღებად, რათა შეამოწმოთ არის თუ არა კონფიგურაციები წარმატებული.

### TLS სტანდარტული დაშიფვრა

როგორც ქვემოთ მოცემულია ფიგურაში, არის ეს პატარა საკეტი, რაც ნიშნავს, რომ SSL სერთიფიკატი წარმატებით ჩართულია.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/SrdbAwh.webp)

შემდეგ დააჭირეთ "აჩვენე ორიგინალური ელფოსტა"

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/qQQsdxg.webp)

### DKIM

როგორც ქვემოთ მოცემულ სურათზეა ნაჩვენები, Gmail-ის ორიგინალური ფოსტის გვერდი აჩვენებს DKIM, რაც ნიშნავს, რომ DKIM კონფიგურაცია წარმატებულია.

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/an6aXK6.webp)

შეამოწმეთ Received ორიგინალური ელფოსტის სათაურში და ხედავთ, რომ გამგზავნის მისამართია IPV6, რაც ნიშნავს, რომ IPV6 ასევე წარმატებით არის კონფიგურირებული.
